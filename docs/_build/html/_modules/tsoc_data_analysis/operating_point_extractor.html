

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tsoc_data_analysis.operating_point_extractor &mdash; TSOC Data Analysis 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            TSOC Data Analysis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">TSOC Data Analysis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tsoc_data_analysis.operating_point_extractor</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tsoc_data_analysis.operating_point_extractor</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Representative Operating Points Extraction Module</span>

<span class="sd">Author: Sustainable Power Systems Lab (SPSL)</span>
<span class="sd">Web: https://sps-lab.org</span>
<span class="sd">Contact: info@sps-lab.org</span>

<span class="sd">This module provides functions to extract representative operating points </span>
<span class="sd">from power system data using K-means clustering with automatic cluster count selection.</span>

<span class="sd">CLUSTERING METHODOLOGY:</span>
<span class="sd">======================</span>

<span class="sd">The module implements the methodology described in &quot;Automated Extraction of </span>
<span class="sd">Representative Operating Points for a 132 kV Transmission System&quot;:</span>

<span class="sd">1. DATA FILTERING: Based on power limits and MAPGL constraints</span>
<span class="sd">2. FEATURE EXTRACTION: Uses power injection features (ss_mw_*, ss_mvar_*, wind_mw_*)</span>
<span class="sd">3. STANDARDIZATION: Applies StandardScaler for feature normalization</span>
<span class="sd">4. CLUSTERING: K-means with automatic cluster count selection using multiple metrics</span>
<span class="sd">5. MEDOID SELECTION: Returns actual snapshots closest to cluster centers</span>
<span class="sd">6. MAPGL BELT: Includes critical low-load operating points near MAPGL threshold</span>
<span class="sd">7. OUTPUT GENERATION: Saves results with clean column names and comprehensive reports</span>

<span class="sd">CONFIGURATION INTEGRATION:</span>
<span class="sd">=========================</span>

<span class="sd">All parameters are imported from config.REPRESENTATIVE_OPS:</span>

<span class="sd">- defaults: k_max, random_state, mapgl_belt_multiplier, fallback_clusters</span>
<span class="sd">- kmeans: n_init, algorithm settings</span>
<span class="sd">- quality_thresholds: min_silhouette, excellent/good/acceptable thresholds  </span>
<span class="sd">- ranking_weights: Multi-objective ranking weights for cluster selection</span>
<span class="sd">- feature_columns: Column prefixes for clustering features</span>
<span class="sd">- output_files: Standardized output file names</span>
<span class="sd">- validation: Display limits and data requirements</span>

<span class="sd">ENHANCED FEATURES:</span>
<span class="sd">=================</span>

<span class="sd">- CLEAN OUTPUT: Uses centralized clean_column_name() for readable CSV files</span>
<span class="sd">- QUALITY ASSESSMENT: Multi-objective cluster quality evaluation</span>
<span class="sd">- COMPREHENSIVE REPORTING: Detailed clustering summary with diagnostics</span>
<span class="sd">- ADAPTIVE ALGORITHMS: Automatically adjusts to data characteristics</span>
<span class="sd">- POWER SYSTEM FOCUS: Specialized for electrical power system analysis</span>

<span class="sd">Functions:</span>
<span class="sd">- loadallpowerdf(): Load all_power*.csv files from directory</span>
<span class="sd">- extract_representative_ops(): Main function to extract representative points</span>
<span class="sd">- _select_feature_columns(): Helper to identify clustering features (config-driven)</span>
<span class="sd">- _auto_kmeans(): Helper for automatic K-means cluster selection (config-driven)</span>
<span class="sd">- _create_clustering_summary(): Generates comprehensive analysis reports</span>

<span class="sd">USAGE EXAMPLES:</span>
<span class="sd">==============</span>

<span class="sd"># Load all_power data from directory</span>
<span class="sd">df = loadallpowerdf(&#39;results&#39;)</span>

<span class="sd"># Basic usage with default configuration</span>
<span class="sd">rep_df, diagnostics = extract_representative_ops(</span>
<span class="sd">    all_power=df, max_power=850, MAPGL=200</span>
<span class="sd">)</span>

<span class="sd"># Save results with automatic file naming</span>
<span class="sd">rep_df, diagnostics = extract_representative_ops(</span>
<span class="sd">    all_power=df, max_power=850, MAPGL=200, </span>
<span class="sd">    output_dir=&quot;results&quot;  # Uses config file names</span>
<span class="sd">)</span>

<span class="sd"># Combined workflow: load data and extract representative points</span>
<span class="sd">rep_df, diagnostics = extract_representative_ops(</span>
<span class="sd">    loadallpowerdf(&#39;results&#39;), max_power=850, MAPGL=200, output_dir=&#39;results&#39;</span>
<span class="sd">)</span>

<span class="sd"># Custom parameters (overrides config defaults)</span>
<span class="sd">rep_df, diagnostics = extract_representative_ops(</span>
<span class="sd">    all_power=df, max_power=850, MAPGL=200,</span>
<span class="sd">    k_max=15, random_state=123  # Override config values</span>
<span class="sd">)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">silhouette_score</span><span class="p">,</span>
    <span class="n">calinski_harabasz_score</span><span class="p">,</span>
    <span class="n">davies_bouldin_score</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.system_configuration</span><span class="w"> </span><span class="kn">import</span> <span class="n">clean_column_name</span><span class="p">,</span> <span class="n">REPRESENTATIVE_OPS</span><span class="p">,</span> <span class="n">convert_numpy_types</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;extract_representative_ops&quot;</span><span class="p">,</span> <span class="s2">&quot;loadallpowerdf&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="loadallpowerdf">
<a class="viewcode-back" href="../../api/operating_point_extractor.html#tsoc_data_analysis.operating_point_extractor.loadallpowerdf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">loadallpowerdf</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load all_power*.csv file from the specified directory into a DataFrame.</span>
<span class="sd">    </span>
<span class="sd">    This function searches for files matching the pattern &#39;all_power*.csv&#39; in the</span>
<span class="sd">    specified directory and loads the first matching file. It&#39;s designed to work</span>
<span class="sd">    with the power system analysis workflow where all_power data files are</span>
<span class="sd">    generated with timestamps or version suffixes.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    directory : str</span>
<span class="sd">        Directory path to search for all_power*.csv files.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Loaded DataFrame with power system data. The index is preserved as</span>
<span class="sd">        timestamps if present in the original CSV file.</span>
<span class="sd">        </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        If no all_power*.csv file is found in the specified directory.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the directory doesn&#39;t exist or is not accessible.</span>
<span class="sd">        </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # Load all_power data from results directory</span>
<span class="sd">    &gt;&gt;&gt; df = loadallpowerdf(&#39;results&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Loaded {len(df)} snapshots with {len(df.columns)} columns&quot;)</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; # Use in representative operating points extraction</span>
<span class="sd">    &gt;&gt;&gt; rep_df, diagnostics = extract_representative_ops(</span>
<span class="sd">    ...     loadallpowerdf(&#39;results&#39;), max_power=850, MAPGL=200, output_dir=&#39;results&#39;</span>
<span class="sd">    ... )</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Searches for files matching pattern &#39;all_power*.csv&#39;</span>
<span class="sd">    - Uses pandas.read_csv() with automatic index parsing</span>
<span class="sd">    - Preserves original column names and data types</span>
<span class="sd">    - Handles common CSV formats with comma or semicolon separators</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
    
    <span class="c1"># Check if directory exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39; does not exist&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39; is not a directory&quot;</span><span class="p">)</span>
    
    <span class="c1"># Search for all_power*.csv files</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;all_power*.csv&quot;</span><span class="p">)</span>
    <span class="n">matching_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matching_files</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No all_power*.csv files found in directory &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Searched pattern: </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># Use the first matching file (most recent if sorted)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">matching_files</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Try to read with automatic index parsing (for timestamps)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="c1"># Fallback: read without index parsing if it fails</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="c1"># Final fallback: read without index</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded all_power data from: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Shape: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> rows × </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> columns&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Columns: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span><span class="si">}{</span><span class="s1">&#39;...&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_select_feature_columns</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return columns starting with ss_mw_, ss_mvar_ or wind_mw_.&quot;&quot;&quot;</span>
    <span class="n">keep_prefix</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;feature_columns&#39;</span><span class="p">][</span><span class="s1">&#39;clustering_prefixes&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">keep_prefix</span><span class="p">)]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_auto_kmeans</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">k_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;defaults&#39;</span><span class="p">][</span><span class="s1">&#39;k_max&#39;</span><span class="p">],</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;defaults&#39;</span><span class="p">][</span><span class="s1">&#39;random_state&#39;</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">KMeans</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit k-means while automatically selecting k with performance optimizations.&quot;&quot;&quot;</span>
    <span class="n">best_model</span><span class="p">:</span> <span class="n">KMeans</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">best_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">best_metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Optimize k range based on data size</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">k_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">k_max</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>  <span class="c1"># Cap at 20 for performance</span>
    <span class="n">k_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">//</span> <span class="mi">100</span><span class="p">))</span>  <span class="c1"># Adaptive minimum k</span>
    
    <span class="c1"># Use parallel processing for multiple k values</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_k</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">km</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span>
                <span class="n">n_clusters</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> 
                <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span> 
                <span class="n">n_init</span><span class="o">=</span><span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;kmeans&#39;</span><span class="p">][</span><span class="s1">&#39;n_init&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">km</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="n">sil</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">calinski_harabasz_score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">davies_bouldin_score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

            <span class="c1"># Multi-objective ranking: maximise CH &amp; Sil, minimise DB</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;ranking_weights&#39;</span><span class="p">]</span>
            <span class="n">combo</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="s1">&#39;calinski_harabasz_weight&#39;</span><span class="p">]</span> <span class="o">+</span> 
                    <span class="n">sil</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="s1">&#39;silhouette_weight&#39;</span><span class="p">]</span> <span class="o">-</span> 
                    <span class="n">db</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="s1">&#39;davies_bouldin_weight&#39;</span><span class="p">])</span>
            
            <span class="n">min_silhouette</span> <span class="o">=</span> <span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;quality_thresholds&#39;</span><span class="p">][</span><span class="s1">&#39;min_silhouette&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sil</span> <span class="o">&gt;</span> <span class="n">min_silhouette</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">k</span><span class="p">,</span> <span class="n">combo</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;silhouette&quot;</span><span class="p">:</span> <span class="n">sil</span><span class="p">,</span> <span class="s2">&quot;ch&quot;</span><span class="p">:</span> <span class="n">ch</span><span class="p">,</span> <span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="n">db</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{}</span>

    <span class="c1"># Evaluate k values in parallel</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)(</span>
        <span class="n">delayed</span><span class="p">(</span><span class="n">evaluate_k</span><span class="p">)(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_min</span><span class="p">,</span> <span class="n">k_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="c1"># Find best result</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="n">model</span>
            <span class="n">best_k</span> <span class="o">=</span> <span class="n">k</span>
            <span class="n">best_metrics</span> <span class="o">=</span> <span class="n">metrics</span>

    <span class="k">if</span> <span class="n">best_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># fall-back to default clusters</span>
        <span class="n">fallback_k</span> <span class="o">=</span> <span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;defaults&#39;</span><span class="p">][</span><span class="s1">&#39;fallback_clusters&#39;</span><span class="p">]</span>
        <span class="n">best_model</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span>
            <span class="n">n_clusters</span><span class="o">=</span><span class="n">fallback_k</span><span class="p">,</span> 
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span> 
            <span class="n">n_init</span><span class="o">=</span><span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;kmeans&#39;</span><span class="p">][</span><span class="s1">&#39;n_init&#39;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">best_k</span> <span class="o">=</span> <span class="n">fallback_k</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">labels_</span>
        <span class="n">best_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;silhouette&quot;</span><span class="p">:</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">labels</span><span class="p">),</span>
            <span class="s2">&quot;ch&quot;</span><span class="p">:</span> <span class="n">calinski_harabasz_score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">labels</span><span class="p">),</span>
            <span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="n">davies_bouldin_score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">labels</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="n">best_metrics</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_k</span>
    <span class="k">return</span> <span class="n">best_model</span><span class="p">,</span> <span class="n">best_metrics</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_create_visualizations</span><span class="p">(</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">working</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">rep_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">KMeans</span><span class="p">,</span>
    <span class="n">scaler</span><span class="p">:</span> <span class="n">StandardScaler</span><span class="p">,</span>
    <span class="n">feat_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">max_power</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">MAPGL</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create comprehensive visualizations for clustering analysis.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Rectangle</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        
        <span class="c1"># Set style</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8&#39;</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="s2">&quot;husl&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create figure with subplots</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
        
        <span class="c1"># 1. Clustering Quality Metrics Dashboard</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Silhouette&#39;</span><span class="p">,</span> <span class="s1">&#39;Calinski-Harabasz&#39;</span><span class="p">,</span> <span class="s1">&#39;Davies-Bouldin&#39;</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;silhouette&#39;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ch&#39;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;silhouette&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s1">&#39;orange&#39;</span> <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;silhouette&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.25</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ch&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="s1">&#39;orange&#39;</span> <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ch&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s1">&#39;orange&#39;</span> <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span>
        
        <span class="n">bars</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Clustering Quality Metrics&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
        
        <span class="c1"># Add value labels on bars</span>
        <span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        
        <span class="c1"># 2. Cluster Size Distribution</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cluster_sizes</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;cluster_sizes&#39;</span><span class="p">]</span>
        <span class="n">cluster_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_sizes</span><span class="p">))]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set3</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_sizes</span><span class="p">)))</span>
        
        <span class="n">wedges</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">autotexts</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">cluster_sizes</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">cluster_labels</span><span class="p">,</span> 
                                          <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cluster Size Distribution&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        
        <span class="c1"># 3. Net Load Distribution</span>
        <span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;net_load&#39;</span> <span class="ow">in</span> <span class="n">working</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># Original vs Representative</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">working</span><span class="p">[</span><span class="s1">&#39;net_load&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">rep_df</span><span class="p">[</span><span class="s1">&#39;net_load&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Representative&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">MAPGL</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;MAPGL (</span><span class="si">{</span><span class="n">MAPGL</span><span class="si">}</span><span class="s1"> MW)&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">max_power</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Max Power (</span><span class="si">{</span><span class="n">max_power</span><span class="si">}</span><span class="s1"> MW)&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Net Load (MW)&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Net Load Distribution&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        
        <span class="c1"># 4. Feature Importance (Variance)</span>
        <span class="n">ax4</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feat_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">feature_vars</span> <span class="o">=</span> <span class="n">working</span><span class="p">[</span><span class="n">feat_cols</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">top_features</span> <span class="o">=</span> <span class="n">feature_vars</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ss_mw_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ss_mvar_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;wind_mw_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> 
                           <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">top_features</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
            
            <span class="n">bars</span> <span class="o">=</span> <span class="n">ax4</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_features</span><span class="p">)),</span> <span class="n">top_features</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">ax4</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_features</span><span class="p">)))</span>
            <span class="n">ax4</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Variance&#39;</span><span class="p">)</span>
            <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 10 Features by Variance&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="n">ax4</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        
        <span class="c1"># 5. Compression Analysis</span>
        <span class="n">ax5</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="s1">&#39;Filtered&#39;</span><span class="p">,</span> <span class="s1">&#39;Representative&#39;</span><span class="p">]</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;filtered_size&#39;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_total&#39;</span><span class="p">]]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">]</span>
        
        <span class="n">bars</span> <span class="o">=</span> <span class="n">ax5</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Data Reduction Analysis&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax5</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of Snapshots&#39;</span><span class="p">)</span>
        
        <span class="c1"># Add percentage labels</span>
        <span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">sizes</span><span class="p">):</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
            <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">ax5</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span><span class="o">*</span><span class="mf">0.01</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">percentage</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        
        <span class="c1"># 6. MAPGL Belt Analysis</span>
        <span class="n">ax6</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;net_load&#39;</span> <span class="ow">in</span> <span class="n">working</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mapgl_multiplier</span> <span class="o">=</span> <span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;defaults&#39;</span><span class="p">][</span><span class="s1">&#39;mapgl_belt_multiplier&#39;</span><span class="p">]</span>
            <span class="n">belt_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">working</span><span class="p">[</span><span class="s2">&quot;net_load&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MAPGL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">working</span><span class="p">[</span><span class="s2">&quot;net_load&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mapgl_multiplier</span> <span class="o">*</span> <span class="n">MAPGL</span><span class="p">)</span>
            
            <span class="c1"># Create histogram with MAPGL belt highlighted</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">ax6</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">working</span><span class="p">[</span><span class="s1">&#39;net_load&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">)</span>
            
            <span class="c1"># Highlight MAPGL belt</span>
            <span class="n">belt_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">MAPGL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">mapgl_multiplier</span> <span class="o">*</span> <span class="n">MAPGL</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">belt_indices</span><span class="p">:</span>
                <span class="n">patches</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                <span class="n">patches</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            
            <span class="n">ax6</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">MAPGL</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;MAPGL (</span><span class="si">{</span><span class="n">MAPGL</span><span class="si">}</span><span class="s1"> MW)&#39;</span><span class="p">)</span>
            <span class="n">ax6</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mapgl_multiplier</span> <span class="o">*</span> <span class="n">MAPGL</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                       <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;MAPGL Belt Upper (</span><span class="si">{</span><span class="n">mapgl_multiplier</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAPGL</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> MW)&#39;</span><span class="p">)</span>
            <span class="n">ax6</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Net Load (MW)&#39;</span><span class="p">)</span>
            <span class="n">ax6</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
            <span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;MAPGL Belt Analysis&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="n">ax6</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        
        <span class="c1"># 7. Cluster Centers Heatmap (if not too many features)</span>
        <span class="n">ax7</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feat_cols</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">cluster_centers_orig</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cluster_centers_</span><span class="p">)</span>
            <span class="n">feature_names_short</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ss_mw_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ss_mvar_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;wind_mw_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> 
                                 <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feat_cols</span><span class="p">]</span>
            
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax7</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cluster_centers_orig</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlBu_r&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
            <span class="n">ax7</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">))</span>
            <span class="n">ax7</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">)])</span>
            <span class="n">ax7</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_names_short</span><span class="p">)))</span>
            <span class="n">ax7</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">feature_names_short</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">ax7</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cluster Centers Heatmap&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Feature Value&#39;</span><span class="p">)</span>
        
        <span class="c1"># 8. Quality Assessment Summary</span>
        <span class="n">ax8</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">ax8</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        
        <span class="c1"># Determine overall quality</span>
        <span class="n">silhouette_val</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;silhouette&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">compression_ratio</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_total&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">silhouette_val</span> <span class="o">&gt;</span> <span class="mf">0.7</span> <span class="ow">and</span> <span class="n">compression_ratio</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">overall_quality</span> <span class="o">=</span> <span class="s2">&quot;EXCELLENT&quot;</span>
            <span class="n">quality_color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span>
            <span class="n">quality_emoji</span> <span class="o">=</span> <span class="s2">&quot;🟢&quot;</span>
        <span class="k">elif</span> <span class="n">silhouette_val</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">compression_ratio</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">overall_quality</span> <span class="o">=</span> <span class="s2">&quot;GOOD&quot;</span>
            <span class="n">quality_color</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
            <span class="n">quality_emoji</span> <span class="o">=</span> <span class="s2">&quot;🟡&quot;</span>
        <span class="k">elif</span> <span class="n">silhouette_val</span> <span class="o">&gt;</span> <span class="mf">0.25</span><span class="p">:</span>
            <span class="n">overall_quality</span> <span class="o">=</span> <span class="s2">&quot;ACCEPTABLE&quot;</span>
            <span class="n">quality_color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
            <span class="n">quality_emoji</span> <span class="o">=</span> <span class="s2">&quot;🟠&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overall_quality</span> <span class="o">=</span> <span class="s2">&quot;POOR&quot;</span>
            <span class="n">quality_color</span> <span class="o">=</span> <span class="s2">&quot;darkred&quot;</span>
            <span class="n">quality_emoji</span> <span class="o">=</span> <span class="s2">&quot;🔴&quot;</span>
        
        <span class="n">summary_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="si">{</span><span class="n">quality_emoji</span><span class="si">}</span><span class="s2"> OVERALL QUALITY: </span><span class="si">{</span><span class="n">overall_quality</span><span class="si">}</span>

<span class="s2">📊 CLUSTERING METRICS:</span>
<span class="s2">• Silhouette Score: </span><span class="si">{</span><span class="n">silhouette_val</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">• Calinski-Harabasz: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ch&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span>
<span class="s2">• Davies-Bouldin: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">• Optimal Clusters: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">📈 DATA REDUCTION:</span>
<span class="s2">• Original: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> snapshots</span>
<span class="s2">• Representative: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_total&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> snapshots</span>
<span class="s2">• Compression: </span><span class="si">{</span><span class="n">compression_ratio</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">:1</span>
<span class="s2">• Retention: </span><span class="si">{</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_total&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%</span>

<span class="s2">⚡ REPRESENTATIVE POINTS:</span>
<span class="s2">• Medoids: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_medoid&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">• MAPGL Belt: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_belt&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">• Total: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_total&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">        &quot;&quot;&quot;</span>
        
        <span class="n">ax8</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">summary_text</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax8</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontfamily</span><span class="o">=</span><span class="s1">&#39;monospace&#39;</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.5&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">quality_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
        
        <span class="c1"># 9. Recommendations</span>
        <span class="n">ax9</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
        <span class="n">ax9</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">silhouette_val</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;⚠️ Consider increasing dataset size&quot;</span><span class="p">)</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;⚠️ Review feature selection&quot;</span><span class="p">)</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;⚠️ Check data quality&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">silhouette_val</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;⚠️ Validate results carefully&quot;</span><span class="p">)</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;⚠️ Consider parameter adjustment&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">compression_ratio</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ℹ️ Low data reduction - high diversity&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_belt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ℹ️ No MAPGL belt snapshots found&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recommendations</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;✅ Results look good for analysis&quot;</span><span class="p">)</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;✅ Proceed with power system studies&quot;</span><span class="p">)</span>
        
        <span class="n">rec_text</span> <span class="o">=</span> <span class="s2">&quot;RECOMMENDATIONS:</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recommendations</span><span class="p">)</span>
        <span class="n">ax9</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">rec_text</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax9</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontfamily</span><span class="o">=</span><span class="s1">&#39;monospace&#39;</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.5&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">))</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
        <span class="c1"># Save the visualization</span>
        <span class="n">output_files</span> <span class="o">=</span> <span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;output_files&#39;</span><span class="p">]</span>
        <span class="n">viz_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;clustering_visualization.png&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">viz_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Visualization: </span><span class="si">{</span><span class="n">viz_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: matplotlib/seaborn not available. Skipping visualizations.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not create visualizations: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_create_clustering_summary</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">all_power</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">working</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">rep_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">max_power</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">MAPGL</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">k_max</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">feat_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">KMeans</span><span class="p">,</span>
    <span class="n">scaler</span><span class="p">:</span> <span class="n">StandardScaler</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a comprehensive clustering summary report with improved formatting.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;REPRESENTATIVE OPERATING POINTS CLUSTERING SUMMARY</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Author: Sustainable Power Systems Lab (SPSL)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Web: https://sps-lab.org</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Contact: info@sps-lab.org</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated: </span><span class="si">{</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># EXECUTIVE SUMMARY</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;📋 EXECUTIVE SUMMARY</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Determine overall quality</span>
        <span class="n">silhouette_val</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;silhouette&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">compression_ratio</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_total&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">silhouette_val</span> <span class="o">&gt;</span> <span class="mf">0.7</span> <span class="ow">and</span> <span class="n">compression_ratio</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">overall_quality</span> <span class="o">=</span> <span class="s2">&quot;EXCELLENT&quot;</span>
            <span class="n">quality_emoji</span> <span class="o">=</span> <span class="s2">&quot;🟢&quot;</span>
        <span class="k">elif</span> <span class="n">silhouette_val</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">compression_ratio</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">overall_quality</span> <span class="o">=</span> <span class="s2">&quot;GOOD&quot;</span>
            <span class="n">quality_emoji</span> <span class="o">=</span> <span class="s2">&quot;🟡&quot;</span>
        <span class="k">elif</span> <span class="n">silhouette_val</span> <span class="o">&gt;</span> <span class="mf">0.25</span><span class="p">:</span>
            <span class="n">overall_quality</span> <span class="o">=</span> <span class="s2">&quot;ACCEPTABLE&quot;</span>
            <span class="n">quality_emoji</span> <span class="o">=</span> <span class="s2">&quot;🟠&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overall_quality</span> <span class="o">=</span> <span class="s2">&quot;POOR&quot;</span>
            <span class="n">quality_emoji</span> <span class="o">=</span> <span class="s2">&quot;🔴&quot;</span>
        
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">quality_emoji</span><span class="si">}</span><span class="s2"> Overall Quality: </span><span class="si">{</span><span class="n">overall_quality</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 Clustering Score: </span><span class="si">{</span><span class="n">silhouette_val</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (Silhouette)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📈 Data Reduction: </span><span class="si">{</span><span class="n">compression_ratio</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">:1 (</span><span class="si">{</span><span class="p">((</span><span class="n">compression_ratio</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">compression_ratio</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% reduction)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚡ Representative Points: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_total&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> original</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🎯 Optimal Clusters: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># 1. METHODOLOGY OVERVIEW</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1. 📚 METHODOLOGY OVERVIEW</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;This analysis implements the methodology described in:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&#39;Automated Extraction of Representative Operating Points for a 132 kV Transmission System&#39;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;🔄 Process Steps:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   1️⃣ Data filtering based on power limits and MAPGL constraints</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   2️⃣ Feature extraction from power injection variables</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   3️⃣ Data standardization using StandardScaler</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   4️⃣ K-means clustering with automatic cluster count selection</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   5️⃣ Medoid identification (actual snapshots closest to cluster centers)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   6️⃣ Addition of MAPGL-belt snapshots for critical low-load conditions</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># 2. INPUT PARAMETERS</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;2. ⚙️ INPUT PARAMETERS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔋 Maximum Power Limit:        </span><span class="si">{</span><span class="n">max_power</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MW</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚡ MAPGL (Min Generation):     </span><span class="si">{</span><span class="n">MAPGL</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MW</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🎯 Maximum Clusters Tested:    </span><span class="si">{</span><span class="n">k_max</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🎲 Random State:               </span><span class="si">{</span><span class="n">random_state</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">mapgl_multiplier</span> <span class="o">=</span> <span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;defaults&#39;</span><span class="p">][</span><span class="s1">&#39;mapgl_belt_multiplier&#39;</span><span class="p">]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📏 MAPGL Belt Range:           </span><span class="si">{</span><span class="n">MAPGL</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">mapgl_multiplier</span><span class="o">*</span><span class="n">MAPGL</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MW</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># 3. DATA PROCESSING SUMMARY</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;3. 📊 DATA PROCESSING SUMMARY</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📁 Original Dataset Size:      </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> snapshots</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔍 After Power Filtering:      </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;filtered_size&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> snapshots</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📉 Reduction Factor:           </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;filtered_size&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Data quality information</span>
        <span class="k">if</span> <span class="s1">&#39;data_quality&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;🔍 Data Quality Assessment:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   • Missing Values: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data_quality&#39;</span><span class="p">][</span><span class="s1">&#39;missing_values&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   • Infinite Values: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data_quality&#39;</span><span class="p">][</span><span class="s1">&#39;infinite_values&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   • Zero Variance Features Excluded: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data_quality&#39;</span><span class="p">][</span><span class="s1">&#39;zero_variance_features_excluded&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;🎯 Feature Columns Used for Clustering:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feat_cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📊 Total Features:             </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">feat_cols</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># 4. CLUSTERING RESULTS</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;4. 🎯 CLUSTERING RESULTS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🏆 Optimal Number of Clusters: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📈 Silhouette Score:           </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;silhouette&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 Calinski-Harabasz Index:    </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ch&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📉 Davies-Bouldin Index:       </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;📊 Cluster Composition:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;cluster_sizes&#39;</span><span class="p">]):</span>
            <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;filtered_size&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Cluster </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">size</span><span class="si">:</span><span class="s2">6,</span><span class="si">}</span><span class="s2"> snapshots (</span><span class="si">{</span><span class="n">percentage</span><span class="si">:</span><span class="s2">5.1f</span><span class="si">}</span><span class="s2">%)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Total:       </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;cluster_sizes&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">6,</span><span class="si">}</span><span class="s2"> snapshots (100.0%)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># 5. REPRESENTATIVE POINTS SELECTION</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;5. ⚡ REPRESENTATIVE POINTS SELECTION</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🎯 Medoids from Clusters:      </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_medoid&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📏 MAPGL Belt Snapshots:       </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_belt&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 Total Representative Points: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_total&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📉 Compression Ratio:          </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_total&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">:1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📈 Retention Rate:             </span><span class="si">{</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_total&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># 6. QUALITY ASSESSMENT</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;6. ✅ QUALITY ASSESSMENT</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;📊 Silhouette Score Analysis:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">silhouette_val</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ✅ Excellent separation: Clusters are well-defined and distinct</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ✅ Representative points are highly reliable</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ✅ Strong confidence in operating point selection</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">silhouette_val</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ✅ Good separation: Clusters are reasonably well-defined</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ✅ Representative points are reliable</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ⚠️ Minor overlap between some clusters is acceptable</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">silhouette_val</span> <span class="o">&gt;</span> <span class="mf">0.25</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ⚠️ Moderate separation: Some cluster overlap present</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ⚠️ Representative points should be validated carefully</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ⚠️ Consider additional validation of selected points</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ❌ Poor separation: Significant cluster overlap</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ❌ Representative points may not be reliable</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ❌ Strong recommendation to revise approach</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📈 Calinski-Harabasz Index Analysis (Current: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ch&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ch&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ✅ High index: Well-separated, compact clusters</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ✅ Strong internal cluster cohesion</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ch&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ✅ Moderate index: Reasonably good cluster structure</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ⚠️ Low index: Clusters may be poorly separated or too diffuse</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📉 Davies-Bouldin Index Analysis (Current: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ✅ Excellent: Very low similarity between clusters</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ✅ Good: Low similarity between clusters</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ⚠️ Acceptable: Moderate similarity between clusters</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ❌ Poor: High similarity between clusters indicates overlap</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># 7. RECOMMENDATIONS</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;7. 💡 RECOMMENDATIONS AND NEXT STEPS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">silhouette_val</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;⚠️ LOW CLUSTERING QUALITY WARNING:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   Consider:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Increasing the dataset size</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Reviewing feature selection</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Adjusting power limits or MAPGL</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_total&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;⚠️ FEW REPRESENTATIVE POINTS:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   Consider lowering k_max or adjusting clustering parameters</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;🔧 For power system analysis:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   1. Validate representative points against operational constraints</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   2. Verify load flow convergence for all selected snapshots</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   3. Check that critical operating conditions are captured</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   4. Consider seasonal or temporal patterns if relevant</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># 8. USAGE RECOMMENDATIONS</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;8. 🎯 RECOMMENDED USAGE BASED ON RESULTS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">overall_quality</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;EXCELLENT&quot;</span><span class="p">,</span> <span class="s2">&quot;GOOD&quot;</span><span class="p">]:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;✅ HIGH CONFIDENCE APPLICATIONS:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Long-term transmission planning studies</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Investment analysis and capacity expansion</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Security assessment and contingency analysis</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Renewable integration studies</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Grid code compliance verification</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">overall_quality</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ACCEPTABLE&quot;</span><span class="p">]:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;⚠️ MODERATE CONFIDENCE APPLICATIONS:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Preliminary planning studies (with validation)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Scenario development for detailed analysis</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Identification of critical operating conditions</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ⚠️ Recommend additional validation before final decisions</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">overall_quality</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;POOR&quot;</span><span class="p">]:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;❌ LIMITED CONFIDENCE APPLICATIONS:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Initial screening studies only</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Pattern identification in operational data</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   • Troubleshooting and methodology development</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   ❌ NOT recommended for critical planning decisions</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;END OF CLUSTERING SUMMARY</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="extract_representative_ops">
<a class="viewcode-back" href="../../api/operating_point_extractor.html#tsoc_data_analysis.operating_point_extractor.extract_representative_ops">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_representative_ops</span><span class="p">(</span>
    <span class="n">all_power</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">max_power</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">MAPGL</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">k_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;defaults&#39;</span><span class="p">][</span><span class="s1">&#39;k_max&#39;</span><span class="p">],</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;defaults&#39;</span><span class="p">][</span><span class="s1">&#39;random_state&#39;</span><span class="p">],</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract representative operating points from power system data using clustering.</span>

<span class="sd">    This function implements the methodology described in &quot;Automated Extraction of </span>
<span class="sd">    Representative Operating Points for a 132 kV Transmission System&quot; with a </span>
<span class="sd">    configuration-driven approach for enhanced maintainability and customization.</span>

<span class="sd">    CONFIGURATION-DRIVEN FEATURES:</span>
<span class="sd">    ==============================</span>
<span class="sd">    - All clustering parameters imported from config.REPRESENTATIVE_OPS</span>
<span class="sd">    - Default values managed centrally for consistency across analyses</span>
<span class="sd">    - Feature column selection based on config.REPRESENTATIVE_OPS[&#39;feature_columns&#39;]</span>
<span class="sd">    - Output file names standardized via config.REPRESENTATIVE_OPS[&#39;output_files&#39;]</span>
<span class="sd">    - Clean column names in CSV output using config.clean_column_name()</span>

<span class="sd">    CLUSTERING WORKFLOW:</span>
<span class="sd">    ===================</span>
<span class="sd">    1. Data filtering based on power limits and MAPGL constraints</span>
<span class="sd">    2. Feature extraction using power injection variables (config-driven prefixes)</span>
<span class="sd">    3. Data standardization using StandardScaler</span>
<span class="sd">    4. K-means clustering with automatic cluster count selection</span>
<span class="sd">    5. Multi-objective quality assessment (silhouette, Calinski-Harabasz, Davies-Bouldin)</span>
<span class="sd">    6. Medoid identification (actual snapshots closest to cluster centers)</span>
<span class="sd">    7. MAPGL belt analysis for critical low-load operating points</span>
<span class="sd">    8. Results saved with clean column names and comprehensive diagnostics</span>

<span class="sd">    NET LOAD HANDLING:</span>
<span class="sd">    ==================</span>
<span class="sd">    - If &#39;net_load&#39; column exists in input data, it will be used directly</span>
<span class="sd">    - If &#39;net_load&#39; is missing, it will be calculated from power system data</span>
<span class="sd">    - This avoids redundant calculations when data already contains computed values</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    all_power : pandas.DataFrame</span>
<span class="sd">        Input time-series DataFrame with power system data including columns:</span>
<span class="sd">        - ss_mw_*: Substation active power (MW)</span>
<span class="sd">        - ss_mvar_*: Substation reactive power (MVAR) </span>
<span class="sd">        - wind_mw_*: Wind farm active power (MW)</span>
<span class="sd">        - net_load: Net load (optional, will be calculated if not present)</span>
<span class="sd">        - total_load: Total load (optional, will be calculated if net_load not present)</span>
<span class="sd">    max_power : float</span>
<span class="sd">        Maximum dispatchable generation for the horizon under study [MW].</span>
<span class="sd">    MAPGL : float</span>
<span class="sd">        Minimum active-power generation limit [MW].</span>
<span class="sd">    k_max : int, optional</span>
<span class="sd">        Upper bound for clusters to test. </span>
<span class="sd">        Default from config.REPRESENTATIVE_OPS[&#39;defaults&#39;][&#39;k_max&#39;].</span>
<span class="sd">    random_state : int or None, optional</span>
<span class="sd">        Reproducibility parameter for k-means.</span>
<span class="sd">        Default from config.REPRESENTATIVE_OPS[&#39;defaults&#39;][&#39;random_state&#39;].</span>
<span class="sd">    output_dir : str or None, optional</span>
<span class="sd">        Directory to save results. If provided, saves files with standardized names:</span>
<span class="sd">        - representative_operating_points.csv: Clean column names, timestamps as index</span>
<span class="sd">        - clustering_summary.txt: Comprehensive clustering analysis report</span>
<span class="sd">        - clustering_info.json: Detailed clustering metrics for programmatic access</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rep_df : pandas.DataFrame</span>
<span class="sd">        Subset of input DataFrame containing representative operating points</span>
<span class="sd">        (medoids from clusters plus MAPGL-belt snapshots). Column names retain</span>
<span class="sd">        original structure for compatibility with analysis functions.</span>
<span class="sd">    info : dict</span>
<span class="sd">        Comprehensive diagnostics including:</span>
<span class="sd">        - &#39;k&#39;: Optimal number of clusters selected</span>
<span class="sd">        - &#39;silhouette&#39;: Silhouette score for clustering quality</span>
<span class="sd">        - &#39;ch&#39;: Calinski-Harabasz index</span>
<span class="sd">        - &#39;db&#39;: Davies-Bouldin index  </span>
<span class="sd">        - &#39;cluster_sizes&#39;: Number of points in each cluster</span>
<span class="sd">        - &#39;n_medoid&#39;: Number of medoid representatives</span>
<span class="sd">        - &#39;n_belt&#39;: Number of MAPGL belt snapshots</span>
<span class="sd">        - &#39;n_total&#39;: Total representative points</span>
<span class="sd">        - &#39;original_size&#39;: Size of input dataset</span>
<span class="sd">        - &#39;filtered_size&#39;: Size after filtering</span>
<span class="sd">        - &#39;feature_columns&#39;: Columns used for clustering</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If any surviving snapshot violates net_load &lt; MAPGL, or if no suitable</span>
<span class="sd">        feature columns are found for clustering.</span>

<span class="sd">    Configuration Dependencies</span>
<span class="sd">    -------------------------</span>
<span class="sd">    This function relies on config.REPRESENTATIVE_OPS for:</span>
<span class="sd">    - Default parameter values (k_max, random_state, etc.)</span>
<span class="sd">    - Clustering quality thresholds</span>
<span class="sd">    - Feature column prefixes for automatic selection</span>
<span class="sd">    - Multi-objective ranking weights</span>
<span class="sd">    - Output file naming conventions</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from operating_point_extractor import extract_representative_ops</span>
<span class="sd">    &gt;&gt;&gt; # Basic usage with config defaults</span>
<span class="sd">    &gt;&gt;&gt; rep_df, diag = extract_representative_ops(df, max_power=850, MAPGL=200)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Selected {len(rep_df)} representative points from {len(df)} total&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Optimal clusters: {diag[&#39;k&#39;]} (quality: {diag[&#39;silhouette&#39;]:.3f})&quot;)</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; # Save results with clean column names and comprehensive reports</span>
<span class="sd">    &gt;&gt;&gt; rep_df, diag = extract_representative_ops(</span>
<span class="sd">    ...     df, max_power=850, MAPGL=200, output_dir=&quot;./results&quot;</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; # Files saved: representative_operating_points.csv (clean names),</span>
<span class="sd">    &gt;&gt;&gt; #               clustering_summary.txt, clustering_info.json</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; # Override config defaults for custom analysis</span>
<span class="sd">    &gt;&gt;&gt; rep_df, diag = extract_representative_ops(</span>
<span class="sd">    ...     df, max_power=850, MAPGL=200, k_max=15, random_state=123</span>
<span class="sd">    ... )</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; # Access comprehensive diagnostics</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Compression ratio: {diag[&#39;original_size&#39;]/diag[&#39;n_total&#39;]:.1f}:1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Feature columns: {len(diag[&#39;feature_columns&#39;])}&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Cluster sizes: {diag[&#39;cluster_sizes&#39;]}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Input validation</span>
    <span class="k">if</span> <span class="n">all_power</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input DataFrame is empty&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">max_power</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;max_power must be positive, got </span><span class="si">{</span><span class="n">max_power</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">MAPGL</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAPGL must be positive, got </span><span class="si">{</span><span class="n">MAPGL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">MAPGL</span> <span class="o">&gt;=</span> <span class="n">max_power</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAPGL (</span><span class="si">{</span><span class="n">MAPGL</span><span class="si">}</span><span class="s2">) must be less than max_power (</span><span class="si">{</span><span class="n">max_power</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">k_max</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;k_max must be at least 2, got </span><span class="si">{</span><span class="n">k_max</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Data quality checks</span>
    <span class="n">missing_data</span> <span class="o">=</span> <span class="n">all_power</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">missing_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">missing_data</span><span class="si">}</span><span class="s2"> missing values detected in input data&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check for infinite values</span>
    <span class="n">inf_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">all_power</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">]))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">inf_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input data contains </span><span class="si">{</span><span class="n">inf_count</span><span class="si">}</span><span class="s2"> infinite values&quot;</span><span class="p">)</span>
    
    <span class="c1"># Create working copy</span>
    <span class="n">working</span> <span class="o">=</span> <span class="n">all_power</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Check if net_load and total_load columns already exist</span>
    <span class="k">if</span> <span class="s1">&#39;net_load&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">working</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># Import analysis functions for net load calculation only if needed</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.power_system_analytics</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_total_load</span><span class="p">,</span> <span class="n">calculate_net_load</span>
        
        <span class="c1"># Calculate net load for filtering</span>
        <span class="n">total_load</span> <span class="o">=</span> <span class="n">calculate_total_load</span><span class="p">(</span><span class="n">working</span><span class="p">)</span>
        <span class="n">net_load</span> <span class="o">=</span> <span class="n">calculate_net_load</span><span class="p">(</span><span class="n">working</span><span class="p">,</span> <span class="n">total_load</span><span class="p">)</span>
        <span class="n">working</span><span class="p">[</span><span class="s1">&#39;net_load&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_load</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculated net_load from power system data&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using existing net_load column from input data&quot;</span><span class="p">)</span>

    <span class="c1"># 1 ───────────────── Data integrity checks</span>
    <span class="n">working</span> <span class="o">=</span> <span class="n">working</span><span class="p">[</span><span class="n">working</span><span class="p">[</span><span class="s2">&quot;net_load&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_power</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">working</span><span class="p">[</span><span class="s2">&quot;net_load&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MAPGL</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="n">working</span><span class="p">[</span><span class="n">working</span><span class="p">[</span><span class="s2">&quot;net_load&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MAPGL</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">)</span><span class="si">}</span><span class="s2"> snapshots violate MAPGL (</span><span class="si">{</span><span class="n">MAPGL</span><span class="si">}</span><span class="s2"> MW). &quot;</span>
            <span class="s2">&quot;Aborting; please correct input.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># 2 ───────────────── Feature extraction &amp; scaling</span>
    <span class="n">feat_cols</span> <span class="o">=</span> <span class="n">_select_feature_columns</span><span class="p">(</span><span class="n">working</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feat_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No suitable feature columns found (ss_mw_*, ss_mvar_*, wind_mw_*)&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check feature data quality</span>
    <span class="n">feature_data</span> <span class="o">=</span> <span class="n">working</span><span class="p">[</span><span class="n">feat_cols</span><span class="p">]</span>
    <span class="n">zero_variance_features</span> <span class="o">=</span> <span class="n">feature_data</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">zero_variance_features</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">zero_variance_features</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> features have zero variance and will be excluded&quot;</span><span class="p">)</span>
        <span class="n">feat_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feat_cols</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">zero_variance_features</span><span class="p">[</span><span class="n">col</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feat_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No features with non-zero variance found&quot;</span><span class="p">)</span>
    
    <span class="n">x_raw</span> <span class="o">=</span> <span class="n">working</span><span class="p">[</span><span class="n">feat_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x_raw</span><span class="p">)</span>

    <span class="c1"># 3 ───────────────── K-means with automatic k</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">_auto_kmeans</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k_max</span><span class="o">=</span><span class="n">k_max</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">labels_</span>
    <span class="n">centres</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">cluster_centers_</span>

    <span class="c1"># 4 ───────────────── Medoid identification</span>
    <span class="n">medoid_ids</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">):</span>
        <span class="n">members</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">k</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">members</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">centre</span> <span class="o">=</span> <span class="n">centres</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">member_vecs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">members</span><span class="p">]</span>
        <span class="n">dist2</span> <span class="o">=</span> <span class="p">((</span><span class="n">member_vecs</span> <span class="o">-</span> <span class="n">centre</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Get the position in the members array, then map to DataFrame index</span>
        <span class="n">medoid_pos</span> <span class="o">=</span> <span class="n">members</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">dist2</span><span class="o">.</span><span class="n">argmin</span><span class="p">())]</span>
        <span class="n">medoid_id</span> <span class="o">=</span> <span class="n">working</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">medoid_pos</span><span class="p">]</span>  <span class="c1"># Map array position to DataFrame index</span>
        <span class="n">medoid_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">medoid_id</span><span class="p">)</span>

    <span class="c1"># 5 ───────────────── Append MAPGL belt snapshots</span>
    <span class="n">mapgl_multiplier</span> <span class="o">=</span> <span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;defaults&#39;</span><span class="p">][</span><span class="s1">&#39;mapgl_belt_multiplier&#39;</span><span class="p">]</span>
    <span class="n">belt_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">working</span><span class="p">[</span><span class="s2">&quot;net_load&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MAPGL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">working</span><span class="p">[</span><span class="s2">&quot;net_load&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mapgl_multiplier</span> <span class="o">*</span> <span class="n">MAPGL</span><span class="p">)</span>
    <span class="n">belt_ids</span> <span class="o">=</span> <span class="n">working</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">belt_mask</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">all_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">medoid_ids</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">belt_ids</span><span class="p">))</span>
    <span class="n">rep_df</span> <span class="o">=</span> <span class="n">working</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_ids</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># 6 ───────────────── Return with diagnostics</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">metrics</span><span class="p">,</span>
        <span class="s2">&quot;cluster_sizes&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s2">&quot;n_medoid&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">medoid_ids</span><span class="p">),</span>
        <span class="s2">&quot;n_belt&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">belt_ids</span><span class="p">),</span>
        <span class="s2">&quot;n_total&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rep_df</span><span class="p">),</span>
        <span class="s2">&quot;original_size&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_power</span><span class="p">),</span>
        <span class="s2">&quot;filtered_size&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">working</span><span class="p">),</span>
        <span class="s2">&quot;feature_columns&quot;</span><span class="p">:</span> <span class="n">feat_cols</span><span class="p">,</span>
        <span class="s2">&quot;data_quality&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;missing_values&quot;</span><span class="p">:</span> <span class="n">missing_data</span><span class="p">,</span>
            <span class="s2">&quot;infinite_values&quot;</span><span class="p">:</span> <span class="n">inf_count</span><span class="p">,</span>
            <span class="s2">&quot;zero_variance_features_excluded&quot;</span><span class="p">:</span> <span class="n">zero_variance_features</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;zero_variance_features&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1"># 7 ───────────────── Save results</span>
    <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Save representative operating points as CSV (include timestamps in index)</span>
        <span class="n">output_files</span> <span class="o">=</span> <span class="n">REPRESENTATIVE_OPS</span><span class="p">[</span><span class="s1">&#39;output_files&#39;</span><span class="p">]</span>
        <span class="n">filename_rep</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_files</span><span class="p">[</span><span class="s1">&#39;representative_points&#39;</span><span class="p">])</span>
        
        <span class="c1"># Create a copy with cleaned column names for better readability</span>
        <span class="n">rep_df_clean</span> <span class="o">=</span> <span class="n">rep_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rep_df_clean</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">clean_column_name</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">rep_df_clean</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        
        <span class="n">rep_df_clean</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename_rep</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Create comprehensive clustering summary</span>
        <span class="n">summary_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_files</span><span class="p">[</span><span class="s1">&#39;clustering_summary&#39;</span><span class="p">])</span>
        <span class="n">_create_clustering_summary</span><span class="p">(</span>
            <span class="n">summary_filename</span><span class="p">,</span> <span class="n">all_power</span><span class="p">,</span> <span class="n">working</span><span class="p">,</span> <span class="n">rep_df</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> 
            <span class="n">max_power</span><span class="p">,</span> <span class="n">MAPGL</span><span class="p">,</span> <span class="n">k_max</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="n">feat_cols</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">scaler</span>
        <span class="p">)</span>
        
        <span class="c1"># Also save detailed info as JSON for programmatic access</span>
        <span class="n">json_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_files</span><span class="p">[</span><span class="s1">&#39;clustering_info&#39;</span><span class="p">])</span>
        
        <span class="c1"># Convert the info dictionary to JSON-safe format</span>
        <span class="n">json_safe_info</span> <span class="o">=</span> <span class="n">convert_numpy_types</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_safe_info</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not save JSON file due to serialization error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving simplified JSON without problematic data types...&quot;</span><span class="p">)</span>
            
            <span class="c1"># Fallback: save only basic metrics</span>
            <span class="n">basic_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="s1">&#39;silhouette&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;silhouette&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span>
                <span class="s1">&#39;ch&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span>
                <span class="s1">&#39;db&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span>
                <span class="s1">&#39;cluster_sizes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster_sizes&#39;</span><span class="p">,</span> <span class="p">[])],</span>
                <span class="s1">&#39;n_medoid&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_medoid&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="s1">&#39;n_belt&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_belt&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="s1">&#39;n_total&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="s1">&#39;original_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;original_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="s1">&#39;filtered_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filtered_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="s1">&#39;feature_columns&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;feature_columns&#39;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="p">}</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">basic_info</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        
        <span class="c1"># Create visualizations</span>
        <span class="n">_create_visualizations</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="p">,</span> <span class="n">working</span><span class="p">,</span> <span class="n">rep_df</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">scaler</span><span class="p">,</span> <span class="n">feat_cols</span><span class="p">,</span> <span class="n">max_power</span><span class="p">,</span> <span class="n">MAPGL</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results saved to:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Representative points: </span><span class="si">{</span><span class="n">filename_rep</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Clustering summary: </span><span class="si">{</span><span class="n">summary_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Detailed info (JSON): </span><span class="si">{</span><span class="n">json_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rep_df</span><span class="p">,</span> <span class="n">info</span> </div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Sustainable Power Systems Lab (SPSL).</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>